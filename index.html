<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡∏≠‡∏¢‡πà‡∏≤‡∏°‡∏≤‡∏Å‡∏±‡∏î ‡∏û‡∏µ‡πà‡∏à‡∏±‡∏î‡∏´‡∏ô‡∏±‡∏Å‡∏ô‡∏∞‡∏ô‡πâ‡∏≠‡∏á!</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        :root {
            --neon-green: #2ecc71; --danger-red: #e74c3c; --info-blue: #3498db; --xp-purple: #9b59b6;
            --bg-dark: #0a0a0b; --card-bg: #161618; --border: #2d2d30;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-dark); color: #e0e0e0; margin: 0; padding: 0; user-select: none; padding-top: 155px; padding-bottom: 90px; }
        #screen-battle.active { cursor: crosshair; }
        
        .top-bar { position: fixed; top: 0; left: 0; right: 0; background: rgba(22, 22, 24, 0.9); backdrop-filter: blur(10px); z-index: 1000; padding: 15px; border-bottom: 1px solid var(--border); }
        .status-row { display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center; font-size: 11px; }
        .hud-val { font-weight: bold; color: var(--neon-green); }
        .lang-fixed { position: absolute; top: 12px; right: 15px; background: var(--border); border: 1px solid #444; color: white; font-size: 10px; padding: 4px 8px; border-radius: 4px; cursor: pointer; z-index: 1100; }
        .bar-container { width: 70px; height: 6px; background: #222; border-radius: 10px; overflow: hidden; margin-left: 5px; border: 1px solid #333; }
        .bar-fill { height: 100%; transition: width 0.4s ease; }
        .xp-bar-full { width: 100%; height: 4px; background: #222; margin-top: 10px; border-radius: 2px; }
        .xp-fill { height: 100%; background: var(--xp-purple); width: 0%; transition: width 0.5s; }

        .nav-bar { position: fixed; bottom: 0; width: 100%; background: rgba(22, 22, 24, 0.95); border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 15px 0; z-index: 2000; }
        .nav-btn { background: none; border: none; font-size: 26px; cursor: pointer; opacity: 0.4; transition: 0.3s; }
        .nav-btn.active { opacity: 1; transform: translateY(-5px); }

        .screen { display: none; padding: 15px; max-width: 600px; margin: 0 auto; animation: fadeIn 0.2s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { background: var(--card-bg); padding: 15px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 12px; }
        .btn { width: 100%; padding: 10px; border: none; cursor: pointer; color: white; font-weight: bold; border-radius: 8px; font-size: 11px; text-transform: uppercase; margin: 2px 0; }
        .btn-green { background: #27ae60; } .btn-red { background: #c0392b; } .btn-blue { background: #2980b9; } .btn-orange { background: #d35400; }

        .item-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .item-card { background: #1c1c1f; padding: 10px; text-align: center; border: 1px solid var(--border); border-radius: 10px; font-size: 10px; position: relative; min-height: 75px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        .item-icon-img { width: 35px; height: 35px; object-fit: contain; margin-bottom: 4px; }
        .price-tag { position: absolute; top: -5px; right: -5px; background: #f1c40f; color: #000; padding: 1px 5px; border-radius: 4px; font-size: 9px; font-weight: bold; z-index: 5; }
        .ammo-tag { position: absolute; bottom: 3px; right: 3px; font-size: 9px; color: var(--neon-green); font-weight: bold; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 3000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: #161618; width: 85%; max-width: 380px; border-radius: 15px; border: 1px solid var(--border); padding: 20px; text-align: center; }
        .loot-scroll { max-height: 200px; overflow-y: auto; background: #0d0d0e; border-radius: 10px; padding: 10px; margin: 15px 0; }
        .loot-row { display: flex; align-items: center; justify-content: space-between; padding: 8px; border-bottom: 1px solid #222; font-size: 13px; }

        .battle-container { position: relative; height: 320px; background: #000; border: 2px solid var(--border); border-radius: 15px; overflow: hidden; }
        .zombie-target { position: absolute; width: 80px; height: 80px; z-index: 5; cursor: crosshair; display: none; align-items: center; justify-content: center; font-size: 50px; }
        .zombie-hit { animation: shake 0.1s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        #muzzle-flash { position: absolute; width: 100%; height: 100%; background: white; opacity: 0; pointer-events: none; z-index: 10; }
        #hit-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(231, 76, 60, 0.4); display:none; pointer-events:none; z-index:9999; }
        .floating-dmg { position: fixed; color: #ff4757; font-weight: 900; font-size: 26px; text-shadow: 2px 2px 0px #000; pointer-events: none; z-index: 9999; animation: dmgFloat 0.6s ease-out forwards; }
        @keyframes dmgFloat { 0% { transform: translateY(0) scale(0.5); opacity: 1; } 100% { transform: translateY(-60px) scale(1.1); opacity: 0; } }

        .gear-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-width: 300px; margin: 0 auto; }
        .gear-slot { background: #111; border: 2px dashed #444; border-radius: 12px; aspect-ratio: 1/1; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; position: relative; font-size: 9px; overflow: hidden; }
        .gear-slot.active { border-style: solid; border-color: var(--info-blue); background: #1c1c1f; }
        .slot-name { position: absolute; bottom: 2px; font-size: 8px; opacity: 0.5; text-transform: uppercase; }
        .craft-row { display: flex; justify-content: space-between; align-items: center; background: #1a1a1c; padding: 12px; margin-bottom: 8px; border-radius: 10px; border: 1px solid var(--border); }
        .req-list { font-size: 9px; color: #888; margin-top: 4px; display: block; }
    </style>
</head>
<body>
    <div id="hit-overlay"></div>
    <button class="lang-fixed" onclick="toggleLang()">TH / EN</button>

    <div id="loot-modal" class="modal-overlay">
        <div class="modal-content"><h2 id="lang-loot-title">SUMMARY</h2><div id="loot-xp-total" style="color:var(--xp-purple); font-weight:bold; font-size: 20px;">+0 EXP</div><div class="loot-scroll" id="loot-list-cont"></div><button class="btn btn-green" onclick="closeLootModal()" id="lang-loot-confirm">CONFIRM</button></div>
    </div>

    <div id="item-modal" class="modal-overlay">
        <div class="modal-content">
            <div id="md-icon-cont" style="min-height:80px; display:flex; align-items:center; justify-content:center;"></div>
            <h3 id="md-name">-</h3>
            <div style="text-align:left; background:#0d0d0e; padding:12px; border-radius:8px; margin:15px 0; font-size:12px;">
                <div><span style="color:#888;" id="lbl-desc">Desc</span>: <span id="md-desc">-</span></div>
                <div><span style="color:#888;" id="lbl-stat">Stat</span>: <span id="md-stat">-</span></div>
                <div><span style="color:#888;" id="lbl-sell">Sell</span>: <span id="md-sell">-</span></div>
                <div><span style="color:#888;" id="lbl-from">Source</span>: <span id="md-from">-</span></div>
            </div>
            <button class="btn btn-green" id="md-use-btn">USE</button>
            <button class="btn btn-orange" id="md-stock-btn">STOCK</button>
            <button class="btn btn-red" onclick="closeItemModal()" id="md-close-btn">CLOSE</button>
        </div>
    </div>

    <div class="top-bar">
        <div class="status-row"><span>LVL <span id="hud-lvl" class="hud-val">1</span></span><span style="color:#f1c40f;">$ <span id="hud-gold" class="hud-val">0</span></span><span>KG <span id="hud-weight" class="hud-val">0</span>/50</span></div>
        <div class="status-row">
            ‚ù§Ô∏è <div class="bar-container"><div id="bar-hp" class="bar-fill" style="background:var(--danger-red);"></div></div>
            üçó <div class="bar-container"><div id="bar-hunger" class="bar-fill" style="background:var(--neon-green);"></div></div>
            üíß <div class="bar-container"><div id="bar-thirst" class="bar-fill" style="background:var(--info-blue);"></div></div>
        </div>
        <div class="xp-bar-full"><div id="bar-xp" class="xp-fill"></div></div>
    </div>

    <div id="screen-home" class="screen active">
        <div class="card" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;"><button class="btn btn-blue" onclick="rest()" id="lang-save">SAVE / HEAL</button><button class="btn btn-orange" onclick="changeScreen('storage')" id="lang-stock">STOCK</button></div>
        <div class="card"><h4 id="lang-inv-title">üéí INVENTORY</h4><div id="inventory-list" class="item-grid"></div></div>
    </div>

    <div id="screen-storage" class="screen">
        <div class="card"><h3 id="lang-stock-title">üì¶ STORAGE</h3><div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:10px;"><button class="btn btn-green" onclick="exportItem()" id="lang-export">EXPORT</button><button class="btn btn-blue" onclick="importToStock()" id="lang-import-btn">IMPORT</button></div><div id="storage-list" class="item-grid"></div><button class="btn btn-red" style="margin-top:15px;" onclick="changeScreen('home')">CLOSE</button></div>
    </div>

    <div id="screen-shop" class="screen">
        <div class="card"><h3 id="lang-shop-title">üí∞ SHOP</h3><div id="shop-items-buy" style="max-height: 250px; overflow-y: auto;"></div><hr style="border:0; border-top:1px solid #333; margin:15px 0;"><p id="lang-sell-title" style="font-size:10px; color:#888;">SELL:</p><div id="shop-inventory" class="item-grid"></div><button class="btn btn-red" style="margin-top:15px;" onclick="changeScreen('home')">BACK</button></div>
    </div>

    <div id="screen-craft" class="screen"><div class="card"><h3 id="lang-craft-title">üî® WORKBENCH</h3><div id="craft-list"></div></div></div>
    <div id="screen-char" class="screen"><div class="card" style="text-align: center;"><h3 id="lang-char-title">üë§ LOADOUT</h3><div class="gear-grid"><div></div><div class="gear-slot" id="slot-helmet" onclick="unequip('helmet')"><b>ü™ñ</b><span class="slot-name">Head</span></div><div></div><div class="gear-slot" id="slot-weapon" onclick="unequip('weapon')"><b>üó°Ô∏è</b><span class="slot-name">Wep</span></div><div class="gear-slot" id="slot-armor" onclick="unequip('armor')"><b>üëï</b><span class="slot-name">Body</span></div><div></div><div></div><div class="gear-slot" id="slot-pants" onclick="unequip('pants')"><b>üëñ</b><span class="slot-name">Legs</span></div><div></div><div></div><div class="gear-slot" id="slot-boots" onclick="unequip('boots')"><b>üëû</b><span class="slot-name">Feet</span></div><div></div></div><div style="margin-top:20px; background:#111; padding:15px; border-radius:12px;"><p>MAX HP: <span id="val-maxhp" class="hud-val">100</span></p><small id="lang-hp-info" style="opacity:0.4;">(HP + per level & gear)</small></div></div></div>
    <div id="screen-map" class="screen"><div class="card"><h2 id="lang-map-title" style="text-align:center;">üó∫Ô∏è MAP</h2><div id="dungeon-list"></div></div></div>
    <div id="screen-battle" class="screen"><div style="background:#222; height:8px; width:100%; border-radius:5px; margin-bottom:10px;"><div id="enemy-hp-bar" style="background:var(--danger-red); height:100%; width:100%; border-radius:5px;"></div></div><div id="battle-field" class="battle-container"><div id="muzzle-flash"></div><div id="zombie-target" class="zombie-target" onclick="shootHit(event)">üßü</div></div><div style="display:flex; justify-content:space-between; padding:10px;"><span id="enemy-name" style="color:var(--danger-red); font-weight:bold;">TARGET</span><span style="color:var(--neon-green);">Ammo: <span id="battle-ammo-rem">0</span></span></div><button class="btn btn-red" onclick="fleeBattle()" id="lang-retreat">RETREAT</button></div>

    <div class="nav-bar">
        <button class="nav-btn active" onclick="changeScreen('home')">üè†</button>
        <button class="nav-btn" onclick="changeScreen('shop')">üí∞</button>
        <button class="nav-btn" onclick="changeScreen('craft')">üî®</button>
        <button class="nav-btn" onclick="changeScreen('char')">üë§</button>
        <button class="nav-btn" onclick="changeScreen('map')">üó∫Ô∏è</button>
    </div>

    <script>
        const LANG = {
            th: { 
                save: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å", stock: "‡∏Ñ‡∏•‡∏±‡∏á", import: "‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á", inv: "üéí ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤", stock_t: "üì¶ ‡πÇ‡∏Å‡∏î‡∏±‡∏á", export: "‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å", craft: "üî® ‡πÇ‡∏ï‡πä‡∏∞‡∏Ñ‡∏£‡∏≤‡∏ü", char: "üë§ ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£", map: "‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà", retreat: "‡∏ñ‡∏≠‡∏¢‡∏ó‡∏±‡∏û", req: "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£", shop: "üí∞ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤", hp_info: "(‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡πÅ‡∏•‡∏∞‡∏ä‡∏∏‡∏î)", lbl_desc: "‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢", lbl_stat: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞", lbl_sell: "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢", lbl_from: "‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤", btn_use: "‡πÉ‡∏ä‡πâ/‡πÉ‡∏™‡πà", btn_stock: "‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á", btn_close: "‡∏õ‡∏¥‡∏î", btn_buy: "‡∏ã‡∏∑‡πâ‡∏≠", sell_title: "‡∏Ç‡∏≤‡∏¢‡πÑ‡∏≠‡πÄ‡∏ó‡∏°:", msg_full: "‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏ï‡πá‡∏°!", msg_saved: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß!", msg_clear: "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", msg_FOUND_TITLE: "‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", msg_CONFIRM: "‡∏ï‡∏Å‡∏•‡∏á", src_drop: "‡∏î‡∏£‡∏≠‡∏õ", src_shop: "‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤", src_craft: "‡∏Ñ‡∏£‡∏≤‡∏ü", src_start: "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô", desc_ammo: "‡∏Å‡∏£‡∏∞‡∏™‡∏∏‡∏ô", desc_mat: "‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö", desc_use: "‡∏Ç‡∏≠‡∏á‡∏Å‡∏î‡πÉ‡∏ä‡πâ", desc_gear: "‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå", msg_mats: "‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÑ‡∏°‡πà‡∏û‡∏≠!", msg_received: "‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡πÅ‡∏•‡πâ‡∏ß!", msg_error: "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!", msg_kia: "‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà!"
            },
            en: { 
                save: "SAVE", stock: "STOCK", import: "IMPORT", inv: "üéí BAG", stock_t: "üì¶ STOCK", export: "EXPORT", craft: "üî® CRAFT", char: "üë§ STATUS", map: "MAP", retreat: "RETREAT", req: "REQ", shop: "üí∞ SHOP", hp_info: "(HP + per lvl & gear)", lbl_desc: "Desc", lbl_stat: "Stat", lbl_sell: "Price", lbl_from: "Source", btn_use: "USE", btn_stock: "STOCK", btn_close: "CLOSE", btn_buy: "BUY", sell_title: "SELL:", msg_full: "Bag Full!", msg_saved: "Saved!", msg_clear: "Clear!", msg_FOUND_TITLE: "LOOT SUMMARY", msg_CONFIRM: "CONFIRM", src_drop: "Drop", src_shop: "Shop", src_craft: "Craft", src_start: "Starter", desc_ammo: "Ammo", desc_mat: "Material", desc_use: "Consume", desc_gear: "Gear", msg_mats: "Not Enough mats!", msg_received: "Item Received!", msg_error: "Error Occurred!", msg_kia: "Killed In Action!"
            }
        };
        let curLang = "en";

        const ITEMS = {
            "stone": { name: "Stone Pack", name_th: "‡∏Å‡πâ‡∏≠‡∏ô‡∏´‡∏¥‡∏ô", type: "ammo", weight: 0.5, icon: "image/Stone.png", price: 50, maxUses: 15, source: "src_start", desc: "desc_ammo" },
            "ammo_9mm": { name: "9mm Mag", name_th: "‡∏Å‡∏£‡∏∞‡∏™‡∏∏‡∏ô 9‡∏°‡∏°", type: "ammo", weight: 0.5, icon: "image/Ammo_9mm.png", price: 350, maxUses: 12, source: "src_craft", desc: "desc_ammo" },
            "ammo_556": { name: "5.56 Mag", name_th: "‡∏Å‡∏£‡∏∞‡∏™‡∏∏‡∏ô 5.56‡∏°‡∏°", type: "ammo", weight: 0.5, icon: "image/Ammo_556.png", price: 850, maxUses: 30, source: "src_craft", desc: "desc_ammo" },
            "scrap": { name: "Scrap", name_th: "‡πÄ‡∏®‡∏©‡πÄ‡∏´‡∏•‡πá‡∏Å", type: "mat", weight: 1.0, icon: "image/Scrap.png", price: 40, source: "src_drop", desc: "desc_mat" },
            "gunpowder": { name: "Powder", name_th: "‡∏î‡∏¥‡∏ô‡∏õ‡∏∑‡∏ô", type: "mat", weight: 0.5, icon: "image/GunPowder.png", price: 60, source: "src_drop", desc: "desc_mat" },
                        "watch": { name: "Watch", name_th: "‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤", type: "mat", weight: 0.5, icon: "image/"Watch.png", price: 150, source: "src_drop", desc: "desc_mat" },
            "medkit": { name: "Medkit", name_th: "‡∏¢‡∏≤‡∏Å‡∏•‡πà‡∏≠‡∏á", type: "use", effect: "hp", val: 50, weight: 1.0, icon: "image/Medkit.png", price: 300, source: "src_shop", desc: "desc_use" },
            "slingshot": { name: "Slingshot", name_th: "‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏ï‡∏¥‡πä‡∏Å", type: "weapon", atk: 7, ammoType: "stone", weight: 1.0, icon: "image/Slingshot.png", price: 100, source: "src_start", desc: "desc_gear" },
            "pistol": { name: "Pistol", name_th: "‡∏õ‡∏∑‡∏ô‡∏û‡∏Å", type: "weapon", atk: 15, ammoType: "ammo_9mm", weight: 2.0, icon: "image/Pistol.png", price: 3000, source: "src_shop", desc: "desc_gear" },
            "m16a2": { name: "M16A2", name_th: "‡πÄ‡∏≠‡πá‡∏°16‡πÄ‡∏≠2", type: "weapon", atk: 25, ammoType: "ammo_556", weight: 5.0, icon: "image/M16A2.png", price: 7000, source: "src_shop", desc: "desc_gear" },
            "helmet_1": { name: "Cap", name_th: "‡∏´‡∏°‡∏ß‡∏Å‡πÅ‡∏Å‡πá‡∏õ", type: "helmet", hpBonus: 10, weight: 1.0, icon: "image/Cap.png", price: 800, source: "src_shop", desc: "desc_gear" },
            "armor_1": { name: "T-shirt", name_th: "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏¢‡∏∑‡∏î", type: "armor", hpBonus: 20, weight: 3.0, icon: "image/Tshirt.png", price: 3000, source: "src_shop", desc: "desc_gear" },
            "pants_1": { name: "Pants", name_th: "‡∏Å‡∏≤‡∏á‡πÄ‡∏Å‡∏á‡∏¢‡∏µ‡∏ô‡∏™‡πå", type: "pants", hpBonus: 20, weight: 2.0, icon: "image/Pant.png", price: 1200, source: "src_shop", desc: "desc_gear" },
            "boots_1": { name: "Shoes", name_th: "‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡∏ú‡πâ‡∏≤‡πÉ‡∏ö", type: "boots", hpBonus: 10, weight: 1.0, icon: "image/Shoe.png", price: 1000, source: "src_shop", desc: "desc_gear" }
        };

        const RECIPES = [
            { id: "stone", req: { "scrap": 1 } },
            { id: "ammo_9mm", req: { "scrap": 1, "gunpowder": 1 } },
            { id: "ammo_556", req: { "scrap": 2, "gunpowder": 1 } },
            { id: "pistol", req: { "scrap": 8, "gunpowder": 5 } },
            { id: "m16a2", req: { "scrap": 15, "gunpowder": 12 } },

            
        ];

        const DUNGEONS = [{ name: "Forest", waves: 3, mobType: "Walker", speed: 1800, exp: 20, icon: "üßü" }, { name: "Outpost", waves: 5, mobType: "Stalker", speed: 1100, exp: 50, icon: "üßõ" }];

let player = { 
    lvl: 1, exp: 0, gold: 500, stats: { vit: 0 }, hp: 100, maxHp: 100, 
    maxWeight: 20, maxStorage: 50, // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤ Max Weight ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
    inventory: [{ id: "stone", uses: 15 }, { id: "stone", uses: 15 }], 
    storage: [], 
    equip: { weapon: "slingshot", helmet: null, armor: null, pants: null, boots: null } 
};

                function load() { 
            try { 
        let d = localStorage.getItem('zombie_v19_final_x'); 
        if(d) { 
            let p = JSON.parse(d); 
            if(p && Array.isArray(p.inventory)) {
                player = p;
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ã‡∏ü‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ maxWeight ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
                if(!player.maxWeight) player.maxWeight = 20;
                if(!player.maxStorage) player.maxStorage = 50;
            }
        } 
    } catch(e) {} 
}
                function upgradeStorage() {
            let cost = 1000; // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î 1000
            if(player.gold >= cost) {
        player.gold -= cost;
        player.maxStorage += 10; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏Ñ‡∏•‡∏±‡∏á‡∏ó‡∏µ‡∏•‡∏∞ 10
        alert(curLang==='th' ? "‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (+10kg)" : "Storage Upgraded! (+10kg)");
        updateUI();
    } else {
        alert(curLang==='th' ? "‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠ (1000$)" : "Need 1000$");
    }
}
        function getIconHtml(id, size = "30px") {
            const db = ITEMS[id]; if(!db) return "‚ùì";
            if(db.icon.includes('/')) return `<img src="${db.icon}" class="item-icon-img" style="width:${size}; height:${size};" onerror="this.outerHTML='üì¶'">`;
            return `<div style="font-size:calc(${size} * 0.7)">${db.icon}</div>`;
        }

        // --- TRANSLATION FIX ---
        function toggleLang() { curLang = curLang === "en" ? "th" : "en"; updateUI(); }
        
        function updateUI() {
            const l = LANG[curLang];
            // Update all elements with lang IDs
            const idsToUpdate = [
                {id: "lang-save", key: "save"}, {id: "lang-stock", key: "stock"},
                {id: "import-btn", key: "import"}, {id: "lang-inv-title", key: "inv"},
                {id: "lang-stock-title", key: "stock_t"}, {id: "lang-export", key: "export"},
                {id: "lang-craft-title", key: "craft"}, {id: "lang-char-title", key: "char"},
                {id: "lang-map-title", key: "map"}, {id: "lang-retreat", key: "retreat"},
                {id: "lang-shop-title", key: "shop"}, {id: "lang-sell-title", key: "sell_title"},
                {id: "lang-hp-info", key: "hp_info"}, {id: "lang-loot-title", key: "msg_FOUND_TITLE"},
                {id: "lang-loot-confirm", key: "msg_CONFIRM"}, {id: "lbl-desc", key: "lbl_desc"},
                {id: "lbl-stat", key: "lbl_stat"}, {id: "lbl-sell", key: "lbl_sell"},
                {id: "lbl-from", key: "lbl_from"}, {id: "md-use-btn", key: "btn_use"},
                {id: "md-stock-btn", key: "btn_stock"}, {id: "md-close-btn", key: "btn_close"}
            ];

            idsToUpdate.forEach(item => {
                let el = document.getElementById(item.id);
                if(el) el.innerText = l[item.key] || el.innerText;
            });

            updateHUD();
            // Refresh content based on current active screen
            const activeScreen = document.querySelector('.screen.active')?.id.replace('screen-', '') || 'home';
            changeScreen(activeScreen);
        }

                function updateHUD() {
                    let nextXP = player.lvl * 100;
                    while(player.exp >= nextXP) { player.exp -= nextXP; player.lvl++;  player.stats.vit++; player.hp += 50; nextXP = player.lvl * 100; }
    let gearBonus = 0; for (let s in player.equip) { if (player.equip[s]) gearBonus += ITEMS[player.equip[s]]?.hpBonus || 0; }
    player.maxHp = 100 + (player.stats.vit * 10) + gearBonus;
    if(player.hp > player.maxHp) player.hp = player.maxHp;
    document.getElementById('bar-hp').style.width = (player.hp / player.maxHp * 100) + "%";
    document.getElementById('bar-xp').style.width = (player.exp / nextXP * 100) + "%";
    document.getElementById('hud-gold').innerText = Math.floor(player.gold);
    document.getElementById('hud-lvl').innerText = player.lvl;
    
        document.getElementById('hud-weight').innerText = getWeight(player.inventory) + "/" + player.maxWeight;
    
    save();
}

        function getWeight(list) { return list.reduce((t, i) => t + (ITEMS[i.id]?.weight || 0), 0).toFixed(1); }

        function changeScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            const targetScreen = document.getElementById('screen-'+id);
            if(targetScreen) targetScreen.classList.add('active');
            
            const navMap = {'home':0, 'shop':1, 'craft':2, 'char':3, 'map':4};
            if(navMap[id] !== undefined) document.querySelectorAll('.nav-btn')[navMap[id]].classList.add('active');
            
            if(id === 'home') renderInv('inventory-list');
            if(id === 'storage') renderStorage();
            if(id === 'shop') { renderShop(); renderInv('shop-inventory'); }
            if(id === 'craft') renderCraft();
            if(id === 'char') renderChar();
            if(id === 'map') renderMap();
        }

        // --- BATTLE ---
        function startDungeon(idx) {
            let d = DUNGEONS[idx]; battle.active = true; battle.sessionXP = 0; battle.sessionLoot = [];
            battle.queue = []; for(let i=0; i<d.waves; i++) battle.queue.push({...d}); 
            changeScreen('battle'); nextWave();
        }
        function nextWave() {
            clearInterval(battle.attackTimer); if(!battle.active) return;
            if(battle.queue.length <= 0) { battle.enemy = null; showFinalLootSummary(); return; }
            let m = battle.queue.shift();
            battle.enemy = { hp: 50, maxHp: 50, speed: m.speed, exp: m.exp, mobType: m.mobType, icon: m.icon };
            document.getElementById('enemy-name').innerText = m.mobType + ` (${battle.queue.length + 1})`;
            let t = document.getElementById('zombie-target'); t.innerText = m.icon; t.style.display = 'flex';
            updateBattleUI(); moveZombie(); startZombieTimer();
        }
        function startZombieTimer() {
            clearInterval(battle.attackTimer);
            battle.attackTimer = setInterval(() => {
                if(battle.active && battle.enemy && battle.enemy.hp > 0) {
                    player.hp -= 10; updateHUD();
                    document.getElementById('hit-overlay').style.display='block';
                    setTimeout(()=>document.getElementById('hit-overlay').style.display='none', 100);
                    if(player.hp <= 0) { clearInterval(battle.attackTimer); battle.active = false; alert(LANG[curLang].msg_kia); location.reload(); }
                    else moveZombie();
                }
            }, battle.enemy ? battle.enemy.speed : 1000);
        }
        function moveZombie() {
            const f = document.getElementById('battle-field');
            const t = document.getElementById('zombie-target');
            if(!t || !f) return;
            t.style.left = Math.random()*(f.clientWidth-80)+"px";
            t.style.top = Math.random()*(f.clientHeight-80)+"px";
        }
        function shootHit(e) {
            if(!battle.active || !battle.enemy || battle.enemy.hp <= 0) return;
            let weaponId = player.equip.weapon; if(!weaponId) return;
            let w = ITEMS[weaponId];
            let am = player.inventory.find(i => i.id === w.ammoType);
            if(!am || am.uses <= 0) return;
            am.uses--; if(am.uses <= 0) player.inventory.splice(player.inventory.indexOf(am), 1);
            startZombieTimer(); moveZombie();
            const t = document.getElementById('zombie-target');
            t.classList.add('zombie-hit'); setTimeout(()=> t.classList.remove('zombie-hit'), 100);
            let dmg = Math.floor(Math.random()*5)+(w.atk-2); battle.enemy.hp -= dmg; showDmgFX(e, dmg);
            document.getElementById('muzzle-flash').style.opacity = 0.4; setTimeout(() => document.getElementById('muzzle-flash').style.opacity = 0, 50);
            if(battle.enemy.hp <= 0) { clearInterval(battle.attackTimer); battle.sessionXP += battle.enemy.exp; player.exp += battle.enemy.exp; checkLootAccumulate(); battle.enemy = null; document.getElementById('zombie-target').style.display = 'none'; setTimeout(nextWave, 400); } 
            else updateBattleUI();
            updateHUD();
        }
        function showDmgFX(e, d) { let div = document.createElement('div'); div.className = 'floating-dmg'; div.innerText = d; div.style.left = e.clientX+'px'; div.style.top = (e.clientY-20)+'px'; document.body.appendChild(div); setTimeout(() => div.remove(), 600); }
        function checkLootAccumulate() {
            if(Math.random() < 0.4) {
                const lts = ["scrap", "gunpowder", "medkit"];
                const dId = lts[Math.floor(Math.random()*3)];
                if(parseFloat(getWeight(player.inventory))+ITEMS[dId].weight <= 50) {
                    player.inventory.push({id: dId, uses: ITEMS[dId].maxUses || undefined});
                    battle.sessionLoot.push(dId);
                }
            }
        }
        function showFinalLootSummary() {
            battle.active = false; document.getElementById('loot-modal').style.display = 'flex';
            document.getElementById('loot-xp-total').innerText = `+${battle.sessionXP} EXP`;
            let cont = document.getElementById('loot-list-cont'); cont.innerHTML = "";
            if(battle.sessionLoot.length > 0) {
                let counts = {}; battle.sessionLoot.forEach(id => counts[id] = (counts[id] || 0) + 1);
                for(let id in counts) cont.innerHTML += `<div class="loot-row"><div>${getIconHtml(id, "25px")} ${curLang==='th'?ITEMS[id].name_th:ITEMS[id].name}</div><div style="color:var(--neon-green)">x${counts[id]}</div></div>`;
            } else cont.innerHTML = `<div style="padding:20px; opacity:0.5;">${curLang==='th'?'‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏≠‡πÄ‡∏ó‡∏°':'No items found'}</div>`;
        }
        function closeLootModal() { document.getElementById('loot-modal').style.display = 'none'; changeScreen('home'); }
        function updateBattleUI() { if(!battle.enemy) return; document.getElementById('enemy-hp-bar').style.width = (battle.enemy.hp/battle.enemy.maxHp*100) + "%"; let w = ITEMS[player.equip.weapon]; let am = player.inventory.find(i => i.id === w?.ammoType); document.getElementById('battle-ammo-rem').innerText = am ? am.uses : 0; }

        // --- RENDER ---
        function renderInv(targetId) {
            let l = document.getElementById(targetId); if(!l) return; l.innerHTML = "";
            player.inventory.forEach((item, i) => {
                let db = ITEMS[item.id]; if(!db) return;
                let d = document.createElement('div'); d.className = 'item-card';
                d.innerHTML = `${getIconHtml(item.id)}${curLang==='en'?db.name:db.name_th}`;
                if(item.uses) d.innerHTML += `<div class="ammo-tag">${item.uses}</div>`;
                if(targetId === 'shop-inventory') d.innerHTML += `<div class="price-tag">$${Math.floor(db.price * 0.5)}</div>`;
                d.onclick = () => { if(targetId === 'shop-inventory') sellItem(i); else showItemDetail(i, 'bag'); };
                l.appendChild(d);
            });
        }
        function renderStorage() {
    let l = document.getElementById('storage-list'); if(!l) return; l.innerHTML = "";
    
       let wInfo = `<div style="text-align:center; margin-bottom:10px; font-size:11px; color:#888;">
        STOCK: <span style="color:#fff">${getWeight(player.storage)} / ${player.maxStorage} KG</span> 
        <button class="btn btn-orange" style="width:auto; padding:2px 6px; font-size:9px; margin-left:5px;" onclick="upgradeStorage()">UP (+10kg) $1000</button>
    </div>`;
    
       let controls = `<div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:10px;"><button class="btn btn-green" onclick="exportItem()" id="lang-export">${LANG[curLang].export}</button><button class="btn btn-blue" onclick="importToStock()" id="lang-import-btn">${LANG[curLang].import}</button></div>`;
    
      let listHTML = "";
    player.storage.forEach((item, i) => listHTML += `<div class="item-card" onclick="showItemDetail(${i}, 'stock')">${getIconHtml(item.id)}${curLang==='en'?ITEMS[item.id].name:ITEMS[item.id].name_th}</div>`);
    
    l.parentElement.innerHTML = `<h3 id="lang-stock-title">${LANG[curLang].stock_t}</h3>${wInfo}${controls}<div id="storage-list" class="item-grid">${listHTML}</div><button class="btn btn-red" style="margin-top:15px;" onclick="changeScreen('home')">${LANG[curLang].btn_close}</button>`;
}
        }
        function showItemDetail(index, loc) {
            const it = (loc === 'bag') ? player.inventory[index] : player.storage[index]; if(!it) return;
            const db = ITEMS[it.id]; document.getElementById('item-modal').style.display = 'flex';
            document.getElementById('md-icon-cont').innerHTML = getIconHtml(it.id, "80px");
            document.getElementById('md-name').innerText = curLang === 'th' ? db.name_th : db.name;
            document.getElementById('md-desc').innerText = LANG[curLang][db.desc];
            document.getElementById('md-from').innerText = LANG[curLang][db.source];
            document.getElementById('md-sell').innerText = "$" + Math.floor(db.price * 0.5);
            document.getElementById('md-stat').innerText = db.hpBonus ? "HP +"+db.hpBonus : (db.atk ? "ATK "+(db.atk-2)+"-"+(db.atk+2) : "-");
            const ub = document.getElementById('md-use-btn'); const sb = document.getElementById('md-stock-btn');
            if(loc === 'bag') { sb.style.display='block'; sb.onclick=()=>{ moveItem(index, 'inventory', 'storage'); closeItemModal(); }; ub.style.display=(db.type==='ammo'||db.type==='mat')?'none':'block'; ub.onclick=()=>{ useItem(index); closeItemModal(); }; }
            else { sb.style.display='none'; ub.style.display='block'; ub.innerText=curLang==='th'?"‡πÄ‡∏≠‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏±‡∏ß":"TAKE"; ub.onclick=()=>{ moveItem(index, 'storage', 'inventory'); closeItemModal(); }; }
        }
        function closeItemModal() { document.getElementById('item-modal').style.display = 'none'; }
        function useItem(idx) {
            const it = player.inventory[idx]; const db = ITEMS[it.id];
            if(db.type === 'use') { player.hp = Math.min(player.maxHp, player.hp + db.val); player.inventory.splice(idx, 1); }
            else if(['weapon','helmet','armor','pants','boots'].includes(db.type)) { let old = player.equip[db.type]; player.equip[db.type] = it.id; player.inventory.splice(idx, 1); if(old) player.inventory.push({id:old}); }
            updateUI();
        }
        function moveItem(i, f, t) { 
    let it = player[f][i]; 
    let w = ITEMS[it.id]?.weight || 0;
    let targetLimit = (t === 'inventory') ? player.maxWeight : player.maxStorage; // ‡πÄ‡∏ä‡πá‡∏Ñ Limit ‡πÅ‡∏¢‡∏Å
    
    if(parseFloat(getWeight(player[t])) + w > targetLimit) { 
        alert(LANG[curLang].msg_full + ` (Max: ${targetLimit}kg)`); 
    } else { 
        player[t].push(player[f].splice(i, 1)[0]); 
    } 
    updateUI(); 
}
        function renderShop() { let b = document.getElementById('shop-items-buy'); b.innerHTML = ""; ["stone", "ammo_9mm", "ammo_556", "medkit", "helmet_1", "armor_1", "pants_1", "boots_1", "pistol"].forEach(id => { let db = ITEMS[id]; b.innerHTML += `<div class="craft-row" style="position:relative;"><div class="price-tag">$${db.price}</div><div>${getIconHtml(id)} ${curLang==='en'?db.name:db.name_th}</div><button class="btn btn-green" style="width:60px" onclick="buyItem('${id}')">${LANG[curLang].btn_buy}</button></div>`; }); }
        function buyItem(id) { 
    if(player.gold >= ITEMS[id].price) {
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏±‡∏ö player.maxWeight (20kg)
        if (parseFloat(getWeight(player.inventory)) + ITEMS[id].weight <= player.maxWeight) { 
            player.gold -= ITEMS[id].price; 
            player.inventory.push({ id: id, uses: ITEMS[id].maxUses || undefined }); 
            updateUI(); 
        } else {
            alert(LANG[curLang].msg_full);
        }
    } 
}
        function sellItem(i) { player.gold += Math.floor(ITEMS[player.inventory[i].id].price * 0.5); player.inventory.splice(i, 1); updateUI(); }
        function renderCraft() { let l = document.getElementById('craft-list'); l.innerHTML = ""; RECIPES.forEach(r => { let db = ITEMS[r.id]; let reqs = Object.entries(r.req).map(([id, q]) => `${curLang==='th'?ITEMS[id].name_th:ITEMS[id].name} x${q}`).join(", "); l.innerHTML += `<div class="craft-row"><div>${getIconHtml(r.id)} <b>${curLang==='en'?db.name:db.name_th}</b><br><small style="color:#888;">${LANG[curLang].req}: ${reqs}</small></div><button class="btn btn-green" style="width:70px" onclick="craft('${r.id}')">CRAFT</button></div>`; }); }
        function craft(id) { 
    let r = RECIPES.find(x => x.id === id); 
    for(let [mId, q] of Object.entries(r.req)) { if(player.inventory.filter(it => it.id === mId).length < q) { alert(LANG[curLang].msg_mats); return; } } 
    
        if (parseFloat(getWeight(player.inventory)) + ITEMS[id].weight > player.maxWeight + 5) {          alert(LANG[curLang].msg_full); return;
    }

    Object.entries(r.req).forEach(([mId, q]) => { for(let i=0; i<q; i++) { let idx = player.inventory.findIndex(it => it.id === mId); if(idx !== -1) player.inventory.splice(idx, 1); } }); 
    player.inventory.push({ id: id, uses: ITEMS[id].maxUses || undefined }); 
    updateUI(); 
}
        function renderMap() { let l = document.getElementById('dungeon-list'); l.innerHTML = ""; DUNGEONS.forEach((d, i) => l.innerHTML += `<div class="card" style="display:flex; justify-content:space-between; align-items:center;"><span><b>${d.name}</b><br><small>Waves: ${d.waves}</small></span><button class="btn btn-red" style="width:80px" onclick="startDungeon(${i})">GO</button></div>`); }
        function unequip(s) { 
    if(player.equip[s]) { 
        let id = player.equip[s]; 
        if(parseFloat(getWeight(player.inventory)) + ITEMS[id].weight <= player.maxWeight) { 
            player.inventory.push({id: id}); 
            player.equip[s] = null; 
            updateUI(); 
        } else {
            alert(LANG[curLang].msg_full);
        }
    } 
}
function checkLootAccumulate() {
    if(Math.random() > 0.4) return; 

    let chance = Math.floor(Math.random() * 100);
    let dId = "";

   
    if(chance < 50) { 
        dId = "scrap";       // 0-49 (‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ 50%) = ‡∏Ç‡∏≠‡∏á‡∏´‡∏≤‡∏á‡πà‡∏≤‡∏¢
    } else if(chance < 80) {
        dId = "gunpowder";   // 50-79 (‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ 30%) = ‡∏Ç‡∏≠‡∏á‡∏õ‡∏Å‡∏ï‡∏¥
    } else if(chance < 95) {
        dId = "watch";    // 80-94 (‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ 15%) = ‡∏Ç‡∏≠‡∏á‡∏´‡∏≤‡∏¢‡∏≤‡∏Å
    } else {
        dId = "medkit";      // 95-99 (‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ 5%)  = ‡∏Ç‡∏≠‡∏á‡πÅ‡∏£‡∏£‡πå
    }

  }
function importToStock() { 
    let code = prompt("PASTE CODE:"); 
    try { 
        let item = JSON.parse(atob(code)); 
        if(item.id) { 
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏Ñ‡∏•‡∏±‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á
            let w = ITEMS[item.id]?.weight || 0;
            if(parseFloat(getWeight(player.storage)) + w <= player.maxStorage) {
                player.storage.push(item); 
                alert(LANG[curLang].msg_received); 
                updateUI(); 
            } else {
                alert("Storage Full!");
            }
        } 
    } catch(e) { alert(LANG[curLang].msg_error); } 
}
        function fleeBattle() { clearInterval(battle.attackTimer); battle.active = false; changeScreen('home'); }
        function exportItem() { let idx = prompt("Index (1,2...)")-1; if(player.storage[idx]) { let code = btoa(JSON.stringify(player.storage.splice(idx,1)[0])); prompt("CODE:", code); updateUI(); } }
        function importToStock() { let code = prompt("PASTE CODE:"); try { let item = JSON.parse(atob(code)); if(item.id) { player.storage.push(item); alert(LANG[curLang].msg_received); updateUI(); } } catch(e) { alert(LANG[curLang].msg_error); } }
        function save() { localStorage.setItem('zombie_v19_final_x', JSON.stringify(player)); }
        function load() { try { let d = localStorage.getItem('zombie_v19_final_x'); if(d) { let p = JSON.parse(d); if(p && Array.isArray(p.inventory)) player = p; } } catch(e) {} }

        window.onload = function() { load(); updateUI(); changeScreen('home'); };
    </script>
</body>
</html>
